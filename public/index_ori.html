<!DOCTYPE html>
<html>
<head>
  <title>Drive Markdown to Gemini</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>

  <style>
    /* ä½ å¯ä»¥åœ¨é€™è£¡åŠ å…¥ä¸€äº› CSS æ¨£å¼ä¾†ç¾åŒ–ä»‹é¢ */
    body {
      font-family: sans-serif;
      line-height: 1.6;
      margin: 20px;
    }
    main {
      max-width: 600px;
      margin: 0 auto;
    }
    .prompt-box {
      display: flex;
      margin-bottom: 20px;
    }
    .prompt-box input[type="text"] {
      flex-grow: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-right: 10px;
    }
    .prompt-box button {
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .prompt-box button:hover {
      background-color: #0056b3;
    }
    .output {
      border: 1px solid #ccc;
      padding: 15px;
      min-height: 100px;
      white-space: pre-wrap; /* ä¿ç•™æ›è¡Œç¬¦è™Ÿ */
    }
  </style>
</head>
<body>
  <h1>Google Drive çŸ¥è­˜åº«æŸ¥è©¢</h1>
  <button onclick="handleSignIn()">ç™»å…¥ Google</button>
  è¼¸å…¥è³‡æ–™å¤¾ ID<input id="folderIdInput" placeholder="è¼¸å…¥è³‡æ–™å¤¾ ID" size="50">
  <button onclick="process()">å–å¾—è³‡æ–™</button>
  <textarea id="messageInput" placeholder="Type your message here..." rows="5" cols="40" ></textarea>
API Key <input type="password" id="apiKey" placeholder="API Key" />
<button onclick="sendMessage()">é€å‡º</button>
  <input id="userQuestion" style="display: none;" placeholder="è¼¸å…¥ä½ çš„å•é¡Œ" size="50">
  <br/>
  
  <div class="inputs">
    

    
</div>
  <p class="output" id="answer" style="display: none;">(AI çš„å›ç­”æœƒé¡¯ç¤ºåœ¨é€™è£¡)</p> 
  
  <pre id="output" style="display: none;"></pre>


  <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js
  "></script>
          <style>
              * {
                  padding: 0;
                  margin: 0;
                  box-sizing: border-box;
              }
              body {
                  font-family: system-ui, -apple-system, BlinkMacSystemFont,
                      "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans",
                      "Helvetica Neue", sans-serif;
                  padding: 2rem;
                  display: flex;
                  flex-direction: column;
                  height: 100dvh;
              }
              #chatHistory {
                  /*flex-grow: 1;*/
              }
              .inputs {
                  display: flex;
              }
              #messageInput {
                  flex-grow: 1;
              }
              .inputs > * {
                  height: 2rem;
                  padding: 0.5rem;
              }
              #chatHistory > div {
                  margin-top: 1rem;
              }
          </style>
        <h1>Gemini å•ç­”</h1>
                <div id="chatHistory" style="width: 100%; height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;">
                    <!-- Chat history will appear here -->
                </div>
                
                <script>
                    const converter = new showdown.Converter();
                    let thread = [];
                    function sendMessage() {
                        var apiKey = document.getElementById("apiKey").value;
                        const message = document.getElementById("messageInput").value;
                        thread.push({
                            role: "user",
                            parts: [{ text: message }],
                        });
                        console.log(apiKey);
                        fetch(
                            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=" +
                                apiKey,
                            {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                },
                                body: JSON.stringify({
                                    contents: thread,
                                }),
                            }
                        )
                            .then(response => response.json())
                            .then(data => {
                                const msg = data.candidates[0].content.parts[0].text;
                                const message = document.getElementById("messageInput").value;
                                document.getElementById("chatHistory").innerHTML +=
                                    "<div><div class='author'>AI:</div>" +
                                    converter.makeHtml(msg) + "<br/>You:<br/>" + message
                                    "</div>";
                                    
                                thread.push({
                                    role: "model",
                                    parts: [
                                        {
                                            text: "è«‹ä½ æ‰®æ¼”ä¸€å€‹å€‹äººåŠ©ç†ã€‚ä½ çš„å”¯ä¸€ä»»å‹™æ˜¯æ ¹æ“šä»¥ä¸‹æä¾›çš„ã€ŒèƒŒæ™¯è³‡æ–™ã€ä¾†å›ç­”ã€Œå•é¡Œã€å¦‚æœã€ŒèƒŒæ™¯è³‡æ–™ã€ä¸­æ²’æœ‰è¶³å¤ çš„è³‡è¨Šä¾†å›ç­”å•é¡Œï¼Œè«‹ä½ ç¦®è²Œåœ°å›å¾©ã€ŒæŠ±æ­‰ï¼Œæˆ‘ç„¡æ³•å¾æä¾›çš„è³‡æ–™ä¸­æ‰¾åˆ°ç›¸é—œè³‡è¨Šã€‚ã€ï¼Œä¸è¦ç·¨é€ ç­”æ¡ˆã€‚èƒŒæ™¯è³‡æ–™:" + msg,
                                        },
                                    ],
                                });
                            })
                            .catch(error => {
                                console.error("Error:", error);
                                document.getElementById("chatHistory").innerHTML +=
                                    "<div><div class='author'>Bot:</div>Error: " +
                                    error +
                                    "</div>";
                            });
                    }
                </script>  


  <script>
    let tokenClient;

    function handleSignIn() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: '17673872927-2oerv6lo3asmhmltbok8th3c9un65q7v.apps.googleusercontent.com',
    scope: 'https://www.googleapis.com/auth/drive.readonly',
    callback: (tokenResponse) => {
      gapi.load('client', () => {
        (async () => {
          await gapi.client.init({
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
          });
          gapi.client.setToken(tokenResponse);
          alert('ç™»å…¥æˆåŠŸ');
        })();
      });
    },
  });
  tokenClient.requestAccessToken();
}

    async function listAllMdFiles(folderId) {
      const files = [];

      async function recurse(currentFolderId) {
        const res = await gapi.client.drive.files.list({
          q: `'${currentFolderId}' in parents and trashed = false`,
          fields: 'files(id, name, mimeType)',
          pageSize: 1000,
        });

        for (const file of res.result.files) {
          if (file.mimeType === 'application/vnd.google-apps.folder') {
            await recurse(file.id);
          } else if (file.name.endsWith('.md')) {
            files.push({ id: file.id, name: file.name });
          }
        }
      }

      await recurse(folderId);
      return files;
    }

    async function fetchMarkdownContents(mdFiles) {
      const allContents = [];

      for (const file of mdFiles) {
        try {
          const res = await gapi.client.drive.files.get({
            fileId: file.id,
            alt: 'media'
          });
          allContents.push(`## ${file.name}\n${res.body}`);
        } catch (err) {
          console.warn(`è®€å– ${file.name} å¤±æ•—`, err);
        }
      }

      let merged = allContents.join('\n\n');
      if (merged.length > 30000) {
        merged = merged.slice(0, 30000); // é™åˆ¶é•·åº¦
      }

      return merged;
    }

    async function process() {
      const folderId = document.getElementById('folderIdInput').value.trim();
      const question = document.getElementById('userQuestion').value.trim();
      const output = document.getElementById('output');
      output.textContent = 'è™•ç†ä¸­...';

      if (!folderId) {
        alert("è«‹è¼¸å…¥è³‡æ–™å¤¾ ID èˆ‡å•é¡Œ");
        return;
      }

      try {
        const mdFiles = await listAllMdFiles(folderId);
        if (mdFiles.length === 0) throw new Error("æ‰¾ä¸åˆ° .md æª”æ¡ˆ");

        const mergedContent = await fetchMarkdownContents(mdFiles);
        document.getElementById('messageInput').value = "\nè«‹å›ç­”æˆ‘çš„å•é¡Œï¼š\n  \n" + mergedContent
        // é¡¯ç¤ºåˆä½µå¾Œçš„ Markdown åŸæ–‡
        //document.getElementById('output').textContent = 'ğŸ“„ åˆä½µå…§å®¹ï¼š\n' + mergedContent;
        //const res = await fetch('https://us-central1-personalaihelper-db2aa.cloudfunctions.net/askGemini', {
        //  method: 'POST',
        //  headers: { 'Content-Type': 'application/json' },
        //  body: JSON.stringify({
        //    text: `ä»¥ä¸‹æ˜¯çŸ¥è­˜åº«å…§å®¹ï¼š\n${mergedContent}\n\nä½¿ç”¨è€…å•é¡Œï¼š${question}`
        //  }),
        //});

       // let data;
        //if (res.headers.get('content-type')?.includes('application/json')) {
        //  data = await res.json();
       // } else {
        //  const text = await res.text(); // ğŸ‘ˆ å›å‚³ç´”æ–‡å­—å°±æŠ“é€™å€‹
        //  throw new Error(text);         // ä¸Ÿå‡ºéŒ¯èª¤çµ¦ catch è™•ç†
        //}
        //if (data.answer) {
       //   output.textContent = 'ğŸ” å›ç­”ï¼š\n' + data.answer;
       // } else {
        //  output.textContent = 'âš ï¸ ç„¡æ³•å–å¾—å›ç­”ï¼Œä¼ºæœå™¨å›å‚³ï¼š\n' + JSON.stringify(data, null, 2);
       // }

      } catch (err) {
       // output.textContent = 'âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š\n' + err.message;
       // console.error(err);
      }
    }
  </script>
</body>
</html>
