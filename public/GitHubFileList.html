<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GitHub 檔案清單</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"
    integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
  <script type="text/javascript">
    // 顯示讀取遮罩
    function ShowProgressBar() {
      displayProgress();
      displayMaskFrame();
    }

    // 隱藏讀取遮罩
    function HideProgressBar() {
      var progress = $('#divProgress');
      var maskFrame = $("#divMaskFrame");
      progress.hide();
      maskFrame.hide();
    }
    // 顯示讀取畫面
    function displayProgress() {
      var w = $(document).width();
      var h = $(window).height();
      var progress = $('#divProgress');
      progress.css({
        "z-index": 999999,
        "top": (h / 2) - (progress.height() / 2),
        "left": (w / 2) - (progress.width() / 2)
      });
      progress.show();
    }
    // 顯示遮罩畫面
    function displayMaskFrame() {
      var w = $(window).width();
      var h = $(document).height();
      var maskFrame = $("#divMaskFrame");
      maskFrame.css({
        "z-index": 999998,
        "opacity": 0.7,
        "width": w,
        "height": h
      });
      maskFrame.show();
    }
  </script>
  <style>
    /* 你可以在這裡加入一些 CSS 樣式來美化介面 */
    input,
    button {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px 16px;
      font-family: unset;
      font-size: 16px;
    }

    button {
      background-color: rgb(0, 26, 255);
      color: rgb(255, 242, 0);
      font-weight: bold;
      cursor: pointer;
      opacity: 1;
    }

    button:focus-visible {
      outline: 2px solid white;
      outline-offset: -4px;
    }

    button:hover {
      opacity: 0.95;
    }

    body {
      font-family: sans-serif;
      line-height: 1.6;
      margin: 5px;
    }

    main {
      max-width: 600px;
      margin: 0 auto;
    }

    .prompt-box {
      display: flex;
      margin-bottom: 20px;
    }

    .prompt-box input[type="text"] {
      flex-grow: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-right: 10px;
    }

    .prompt-box button {
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .prompt-box button:hover {
      background-color: #0056b3;
    }

    .output {
      border: 1px solid #ccc;
      padding: 15px;
      min-height: 100px;
      white-space: pre-wrap;
      /* 保留換行符號 */
    }
  </style>
</head>

<body>
  <div id="showMes"></div>
  GitHub 檔案清單
  <button onclick="handleSignIn()">登入 Google</button>

  <style>
    * {
      padding: 0;
      margin: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans",
        "Helvetica Neue", sans-serif;
      padding: 0rem;
      display: flex;
      flex-direction: column;
    }


    .inputs {
      display: flex;
    }

    #messageInput {
      padding: 10px;
      /* Add padding to messageInput textarea */
    }

    #userQuestion {
      padding: 10px;
      /* Add padding to userQuestion textarea */
      flex-grow: 1;
    }

    .inputs>* {
      height: 2rem;
      padding: 0.5rem;
    }

    #chatHistory>div {
      margin-top: 1rem;
    }
  </style>



  <script>
    let tokenClient;
    function handleSignIn() {
      ShowProgressBar();
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: '17673872927-2oerv6lo3asmhmltbok8th3c9un65q7v.apps.googleusercontent.com',
        scope: 'https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email',
        callback: (tokenResponse) => {
          gapi.load('client', () => {
            (async () => {
              await gapi.client.init({
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
                  'https://www.googleapis.com/discovery/v1/apis/oauth2/v2/rest'
                ]
              });
              gapi.client.setToken(tokenResponse);

              //ANCHOR[id=ric25051805] 使用 Google API 获取用户信息
              const userInfoResponse = await gapi.client.oauth2.userinfo.get();
              //ANCHOR[id=ric25051808] googleAccount 帳號資料元件
              const googleAccount = {
                id: userInfoResponse.result.id,
                name: userInfoResponse.result.name,
                imageUrl: userInfoResponse.result.picture,
                email: userInfoResponse.result.email
              };
              //console.log(googleAccount);

              // 發送給 Cloud Function
              try {
                //ANCHOR[id=ric25051806] 發送給 Cloud Function
                //ANCHOR[id=ric25051807] await fetch(url)
                const response = await fetch('https://us-central1-personalaihelper-db2aa.cloudfunctions.net/askGemini', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    text: '請根據我的帳號資訊回傳結果',
                    googleAccount: googleAccount
                  })
                });

                const data = await response.json();
                console.log('Cloud Function 回應:', data);
                //ANCHOR[id=ric25051811] api Key 填入前端文字方塊
                //document.getElementById("apiKey").value = data.aKey;
                //ANCHOR[id=ric25051812] 資料夾ID 填入前端文字方塊
                document.getElementById("gitHubToken").value = data.gitHubToken;
                //if (document.getElementById("folderIdInput").value==''){
                // document.getElementById("folderIdInput").value = data.fId;
                //}
                //const isAutoGetData = document.getElementById('isAutoGetData').checked;
                //ANCHOR[id=ric25052004] 是否在登入成功後自動取得資料
                //if (document.getElementById("folderIdInput").value !== "" && isAutoGetData) {
                //ANCHOR[id=ric25051813] 點擊，取得資料
                //document.getElementById('butProcess').click();
                //} else {
                HideProgressBar();
                // }
                //alert('登入成功');
                $("#showMes").text("登入成功");
              } catch (error) {
                console.error('呼叫 Cloud Function 時發生錯誤:', error);
                alert('呼叫 Cloud Function 時發生錯誤');
              }
            })();
          });
        },
      });
      tokenClient.requestAccessToken();
    }


    async function process() {
      //setTimeout('ShowProgressBar();',50);
      ShowProgressBar();
      GITHUB_TOKEN = document.getElementById('gitHubToken').value.trim();
      init();
    }
  </script>
  <a href="https://levelup.gitconnected.com/how-to-upload-images-to-github-via-javascript-59163b8fff27" target="_blank">❓輸入GITHUB_TOKEN
  </a><input type="password" id="gitHubToken" placeholder="GITHUB TOKEN" />
  <button id="butProcess" onclick="process()">取得資料</button>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 24px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 16px;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }

    th {
      background: #f0f0f0;
    }

    .controls {
      margin-bottom: 16px;
    }

    .controls input {
      padding: 4px;
    }

    .controls button {
      padding: 4px 12px;
    }

    tr:hover {
      background-color: #fff9c4;
      transition: background 0.2s;
    }

    #tab thead {
      position: sticky;
      top: 0;
      background-color: #fff;
      /* 背景色可以根據需要調整 */
      z-index: 1;
    }

    /* 新增的圖片展示區樣式 */
    #imageDisplayArea {
        text-align: center;
        margin-bottom: 20px;
        /* 添加手勢相關樣式 */
        touch-action: pan-y; /* 允許垂直滾動，防止瀏覽器默認的水平滑動行為 */
        overflow: hidden; /* 隱藏圖片超出容器的部分 */
        display: flex; /* 使用 Flexbox 佈局 */
        align-items: center; /* 垂直居中對齊項目 */
        justify-content: center; /* 水平居中對齊項目 */
    }
     #mainImage {
        max-width: 80%;
        max-height: 60vh;
        display: none;
        cursor: grab; /* 更改鼠標樣式表示可拖動 */
        flex-shrink: 0; /* 防止圖片在 Flex 容器中縮小 */
     }
      #mainImage.grabbing {
         cursor: grabbing; /* 更改鼠標樣式表示正在拖動 */
      }

     /* 新增的按鈕樣式 */
     .nav-button {
        font-size: 24px;
        padding: 10px;
        background: none;
        border: none;
        cursor: pointer;
        margin: 0 10px; /* 為按鈕添加左右間距 */
     }
      .nav-button:disabled {
         opacity: 0.5;
         cursor: not-allowed;
      }
  </style>
  <br />
  <!-- 新增的圖片展示區 -->
  <div id="imageDisplayArea">
      <button id="prevImageBtn" class="nav-button" onclick="displayImage(currentImageIndex - 1)" disabled>&#9664;</button> <!-- 左箭頭 -->
      <img id="mainImage" src="" alt="Selected Image">
      <button id="nextImageBtn" class="nav-button" onclick="displayImage(currentImageIndex + 1)" disabled>&#9654;</button> <!-- 右箭頭 -->
  </div>


  <!--<div class="controls">
        <input type="text" id="searchText" placeholder="搜尋檔名...">
        <button onclick="searchFiles()">搜尋</button>&nbsp;&nbsp;
        <button onclick="prevPage()">上一頁</button>&nbsp;&nbsp;
        <button onclick="nextPage()">下一頁</button><br/>
        <span id="pageInfo"></span>
    </div>-->
  <table id="tab">
    <thead>
      <tr>
        <td colspan="3">
          <input type="text" id="searchText" placeholder="搜尋檔名..." style="width: 50%;">
          <button onclick="searchFiles()">搜尋</button>&nbsp;&nbsp;
          <button onclick="prevPage()">上一頁</button>&nbsp;&nbsp;
          <button onclick="nextPage()">下一頁</button><br />
          <span id="pageInfo"></span>
        </td>
      </tr>
      <tr>
        <td>縮圖</td>
        <td>檔名</td>
        <td></td>
      </tr>
    </thead>
    <tbody id="fileList"></tbody>
  </table>

  <script>

    var GITHUB_TOKEN = '';
    const PAGE_SIZE = 30;
    const OWNER = 'ricky9075';
    const REPO = 'web-image';
    const PATH = '';
    let currentPage = 1;
    let searchText = '';
    let allFiles = [];

    // 新增的圖片展示區相關變數和函數
    const mainImage = document.getElementById('mainImage');
    const imageDisplayArea = document.getElementById('imageDisplayArea'); // 獲取圖片展示區元素
    const prevImageBtn = document.getElementById('prevImageBtn'); // 獲取上一頁按鈕
    const nextImageBtn = document.getElementById('nextImageBtn'); // 獲取下一頁按鈕

    let imageUrls = []; // 用於儲存所有圖片的 URL
    let currentImageIndex = -1; // 當前顯示圖片的索引，-1 表示沒有圖片顯示

    function displayImage(index) {
      if (index >= 0 && index < imageUrls.length) {
        mainImage.src = imageUrls[index];
        mainImage.style.display = 'block'; // 顯示圖片
        currentImageIndex = index;
        // 根據索引控制按鈕狀態
        prevImageBtn.disabled = currentImageIndex === 0;
        nextImageBtn.disabled = currentImageIndex === imageUrls.length - 1;
        // 滾動到圖片展示區
        imageDisplayArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } else {
        // 如果索引無效，隱藏圖片並禁用按鈕
        mainImage.src = '';
        mainImage.style.display = 'none'; // 隱藏圖片
        currentImageIndex = -1;
        prevImageBtn.disabled = true;
        nextImageBtn.disabled = true;
      }
    }

    // 加入手勢處理的變數和函數
    let touchStartX = 0;

    function handleTouchStart(event) {
      touchStartX = event.touches[0].clientX;
       // 添加grabbing class來改變鼠標樣式
      mainImage.classList.add('grabbing');
    }

    function handleTouchMove(event) {
      // 可選：加入程式碼來顯示滑動的視覺指示
    }

    function handleTouchEnd(event) {
      // 移除grabbing class
      mainImage.classList.remove('grabbing');

      if (currentImageIndex === -1) return; // 如果沒有圖片顯示，不處理手勢

      const touchEndX = event.changedTouches[0].clientX;
      const swipeDistance = touchEndX - touchStartX;
      const swipeThreshold = 50; // 根據需要調整

      if (swipeDistance > swipeThreshold) {
        // 右滑，顯示上一張圖片
        displayImage(currentImageIndex - 1);
      } else if (swipeDistance < -swipeThreshold) {
        // 左滑，顯示下一張圖片
        displayImage(currentImageIndex + 1);
      }
    }

    // 在圖片展示區添加手勢事件監聽器
    imageDisplayArea.addEventListener('touchstart', handleTouchStart);
    imageDisplayArea.addEventListener('touchmove', handleTouchMove);
    imageDisplayArea.addEventListener('touchend', handleTouchEnd);


    async function fetchFiles() {
      const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${PATH}`;
      const headers = {
        'Authorization': `token ${GITHUB_TOKEN}`,
        'User-Agent': 'Mozilla/5.0'
      };
      const response = await fetch(url, { headers });
      if (!response.ok) {
        alert('GitHub API 錯誤');
        return [];
      }
      let items = await response.json();

      // 顛倒排序並排除 2Hjd9_IMG 開頭
      items = items.reverse().filter(item =>
        item.type === 'file' && !item.path.startsWith('2Hjd9_IMG') && !item.path.startsWith('1.1 system of linear equations')
      );

      // 依檔名（yyyyMMddHHmmss）降冪排序
      items.sort((a, b) => {
        const getDate = (item) => {
          const fileName = item.path.split('/').pop().split('.').shift();
          const dt = Date.parse(
            fileName.replace(
              /^(\d{4})(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})$/,
              '$1-$2-$3T$4:$5:$6Z'
            )
          );
          return isNaN(dt) ? 0 : dt;
        };
        return getDate(b) - getDate(a) ||
          b.path.localeCompare(a.path);
      });

      return items;
    }

    function renderFiles() {
      let filtered = allFiles;
      if (searchText) {
        filtered = filtered.filter(item =>
          item.path.toLowerCase().includes(searchText.toLowerCase())
        );
      }
      const totalPage = Math.ceil(filtered.length / PAGE_SIZE);
      const start = (currentPage - 1) * PAGE_SIZE;
      const paged = filtered.slice(start, start + PAGE_SIZE);

      const tbody = document.getElementById('fileList');
      tbody.innerHTML = '';
      imageUrls = []; // 在渲染新頁面前清空圖片 URL 列表
      currentImageIndex = -1; // 重置當前圖片索引
      mainImage.style.display = 'none'; // 隱藏圖片展示區
      prevImageBtn.disabled = true; // 禁用上一頁按鈕
      nextImageBtn.disabled = true; // 禁用下一頁按鈕


      paged.forEach((item, index) => { // 添加 index 參數以便記錄圖片索引
        const fileName = item.path.split('/').pop();
        const tr = document.createElement('tr');

        let previewHtml = fileName; // 預設顯示檔案名稱

        if (isImage(fileName)) {
          // 如果是圖片，將 URL 加入圖片 URL 列表
          imageUrls.push(item.download_url);
          // 修改點擊行為，呼叫 displayImage 函數顯示大圖
          // 注意這裡傳入的索引是該圖片在 imageUrls 陣列中的索引
          previewHtml = `<img src="${item.download_url}" alt="${fileName}" style="max-width:200px;max-height:200px;cursor:pointer;" onclick="displayImage(${imageUrls.length - 1})">`;
        }

        tr.innerHTML = `
          <td>${previewHtml}</td>
          <td>${fileName}</td>
          <td><a href="${item.download_url}" target="_blank">下載</a></td>
        `;
        tbody.appendChild(tr);
      });

      document.getElementById('pageInfo').textContent =
        `第 ${currentPage} 頁 / 共 ${totalPage} 頁 (${filtered.length} 筆)`;
      HideProgressBar();
    }

    async function init() {
      allFiles = await fetchFiles();
      currentPage = 1;
      renderFiles();
    }
    function isImage(fileName) {
      return /\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(fileName);
    }
    function searchFiles() {
      searchText = document.getElementById('searchText').value.trim();
      currentPage = 1;
      renderFiles();
    }

    function nextPage() {
      let filtered = allFiles;
      if (searchText) {
        filtered = filtered.filter(item =>
          item.path.toLowerCase().includes(searchText.toLowerCase())
        );
      }
      const totalPage = Math.ceil(filtered.length / PAGE_SIZE);
      if (currentPage < totalPage) {
        currentPage++;
        renderFiles();
      }
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderFiles();
      }
    }

    //window.onload = init;
  </script>


  <div id="divProgress" style="text-align:center; display: none; position: fixed; top: 50%;  left: 50%;">
    <img src="loading.gif" />
    <br />
    <font color="#1B3563" size="2px">資料處理中</font>
  </div>
  <div id="divMaskFrame" style="background-color: #F2F4F7; display: none; left: 0px;
  position: absolute; top: 0px;">
  </div>
</body>

</html>