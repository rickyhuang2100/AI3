<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç§äººAIåŠ©ç†</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.slim.min.js"
    integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin="anonymous"></script>
  <script type="text/javascript">
    // é¡¯ç¤ºè®€å–é®ç½©
    function ShowProgressBar() {
      displayProgress();
      displayMaskFrame();
    }

    // éš±è—è®€å–é®ç½©
    function HideProgressBar() {
      var progress = $('#divProgress');
      var maskFrame = $("#divMaskFrame");
      progress.hide();
      maskFrame.hide();
    }
    // é¡¯ç¤ºè®€å–ç•«é¢
    function displayProgress() {
      var w = $(document).width();
      var h = $(window).height();
      var progress = $('#divProgress');
      progress.css({
        "z-index": 999999,
        "top": (h / 2) - (progress.height() / 2),
        "left": (w / 2) - (progress.width() / 2)
      });
      progress.show();
    }
    // é¡¯ç¤ºé®ç½©ç•«é¢
    function displayMaskFrame() {
      var w = $(window).width();
      var h = $(document).height();
      var maskFrame = $("#divMaskFrame");
      maskFrame.css({
        "z-index": 999998,
        "opacity": 0.7,
        "width": w,
        "height": h
      });
      maskFrame.show();
    }
  </script>
  <style>
    /* ä½ å¯ä»¥åœ¨é€™è£¡åŠ å…¥ä¸€äº› CSS æ¨£å¼ä¾†ç¾åŒ–ä»‹é¢ */
    input,
    button {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px 16px;
      font-family: unset;
      font-size: 16px;
    }

    button {
      background-color: rgb(0, 26, 255);
      color: rgb(255, 242, 0);
      font-weight: bold;
      cursor: pointer;
      opacity: 1;
    }

    button:focus-visible {
      outline: 2px solid white;
      outline-offset: -4px;
    }

    button:hover {
      opacity: 0.95;
    }

    body {
      font-family: sans-serif;
      line-height: 1.6;
      margin: 5px;
    }

    main {
      max-width: 600px;
      margin: 0 auto;
    }

    .prompt-box {
      display: flex;
      margin-bottom: 20px;
    }

    .prompt-box input[type="text"] {
      flex-grow: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      margin-right: 10px;
    }

    .prompt-box button {
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .prompt-box button:hover {
      background-color: #0056b3;
    }

    .output {
      border: 1px solid #ccc;
      padding: 15px;
      min-height: 100px;
      white-space: pre-wrap;
      /* ä¿ç•™æ›è¡Œç¬¦è™Ÿ */
    }
  </style>
</head>

<body>
  <div id="showMes"></div>
  GitHub æª”æ¡ˆæ¸…å–®
  <button onclick="handleSignIn()">ç™»å…¥ Google</button>
  <a href="https://share.note.sx/erm7ej0z#Vz6EsicszOcYLioL9K+DRHKQGTXYppHym1QnxSujMvQ" target="_blank">â“è¼¸å…¥è³‡æ–™å¤¾
    ID</a><input id="folderIdInput" placeholder="è³‡æ–™å¤¾ ID" size="50">
  <div class="checkbox-container">
    <input type="checkbox" id="isAutoGetData" name="isAutoGetData" checked/>
    <label for="isAutoGetData">æ˜¯å¦åœ¨ç™»å…¥æˆåŠŸå¾Œè‡ªå‹•å–å¾—è³‡æ–™</label>
  </div>
  <button id="butProcess" onclick="process()">å–å¾—è³‡æ–™</button>
  æ³¨æ„ï¼šåªæœƒè®€å–.mdçš„æª”æ¡ˆå…§å®¹
  <textarea id="messageInput" placeholder="è³‡æ–™å…§å®¹" style="width: 100%;height: 100px;"></textarea>
  <a href="https://share.note.sx/oon2ai7u#WLk+P4DRauu/Nluw1zx9VjxlmDJz0JL/qQbR9YNULC0" target="_blank">â“è¼¸å…¥API Key
  </a><input type="password" id="apiKey" placeholder="API Key" />
  <a href="" target="_blank">â“è¼¸å…¥GITHUB_TOKEN
  </a><input type="password" id="gitHubToken" placeholder="GITHUB TOKEN" />
  è¼¸å…¥å•é¡Œ
  <textarea id="userQuestion" placeholder="å•é¡Œå…§å®¹" style="width: 100%;height: 100px;"></textarea>
  <div class="checkbox-container">
    <input type="checkbox" id="continueQuestion" name="continueQuestion" onchange="document.getElementById('messageInput').disabled = this.checked;" />
    <label for="continueQuestion">æ˜¯å¦æ¥çºŒå•ç­”</label>
  </div>
  <button onclick="sendMessage()">é€å‡º</button>

  <!--//ANCHOR[id=ric25051901] é€å‡º onclick-->

  <div class="inputs">



  </div>
  <p class="output" id="answer" style="display: none;">(AI çš„å›ç­”æœƒé¡¯ç¤ºåœ¨é€™è£¡)</p>

  <pre id="output" style="display: none;"></pre>


  <script src="showdown.min.js"></script>
  <style>
    * {
      padding: 0;
      margin: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont,
        "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans",
        "Helvetica Neue", sans-serif;
      padding: 1rem;
      display: flex;
      flex-direction: column;
    }

    #chatHistory {
      /*flex-grow: 1;*/
    }

    .inputs {
      display: flex;
    }

    #messageInput {
      padding: 10px;
      /* Add padding to messageInput textarea */
    }

    #userQuestion {
      padding: 10px;
      /* Add padding to userQuestion textarea */
      flex-grow: 1;
    }

    .inputs>* {
      height: 2rem;
      padding: 0.5rem;
    }

    #chatHistory>div {
      margin-top: 1rem;
    }
  </style>
  Gemini å•ç­”
  <div id="chatHistory" style="width: 100%; height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;">
    <!-- Chat history will appear here -->
  </div>

  <script>
    const converter = new showdown.Converter();
    let thread = [];

    function sendMessage() {
      var apiKey = document.getElementById("apiKey").value.trim();
      const userQuestion = document.getElementById("userQuestion").value.trim();
      if (!userQuestion || !apiKey) {
        alert("è«‹è¼¸å…¥å•é¡Œå’Œ API Key");
        return;
      }

      ShowProgressBar();
      const message = document.getElementById("messageInput").value;
      var queAndMes = "";
      const isContinuing = document.getElementById('continueQuestion').checked;
      //ANCHOR[id=ric25052001] æ˜¯å¦æ¥çºŒå•ç­”
      if (isContinuing) {
        queAndMes = "è«‹æ¥çºŒä¹‹å‰çš„å•ç­”ï¼Œè«‹å›ç­”æˆ‘çš„å•é¡Œï¼š\n " + userQuestion;
        //ANCHOR[id=ric25052002] ç¬¬næ¬¡å•ç­”ï¼Œã€Œæç¤ºè©ã€åŠ ã€Œå•é¡Œã€
      } else {
        queAndMes =
          "è«‹ä½ æ‰®æ¼”ä¸€å€‹å€‹äººåŠ©ç†ã€‚ä½ çš„å”¯ä¸€ä»»å‹™æ˜¯æ ¹æ“šä»¥ä¸‹æä¾›çš„ã€ŒèƒŒæ™¯è³‡æ–™ã€ä¾†å›ç­”ã€Œå•é¡Œã€å¦‚æœã€ŒèƒŒæ™¯è³‡æ–™ã€ä¸­æ²’æœ‰è¶³å¤ çš„è³‡è¨Šä¾†å›ç­”å•é¡Œï¼Œè«‹ä½ ç¦®è²Œåœ°å›å¾©ã€ŒæŠ±æ­‰ï¼Œæˆ‘ç„¡æ³•å¾æä¾›çš„è³‡æ–™ä¸­æ‰¾åˆ°ç›¸é—œè³‡è¨Šã€‚ã€ï¼Œä¸è¦ç·¨é€ ç­”æ¡ˆã€‚\n è«‹å›ç­”æˆ‘çš„å•é¡Œï¼š" +
          userQuestion + "\n" + "èƒŒæ™¯è³‡æ–™:\n" + message;
        //ANCHOR[id=ric25051902] ç¬¬1æ¬¡å•ç­”ï¼Œã€Œæç¤ºè©ã€åŠ ã€Œå•é¡Œã€åŠ ã€ŒèƒŒæ™¯è³‡æ–™ã€
      }
      //ANCHOR[id=ric25052003] è¨­å®šäº†è®Šæ•¸ thread ä¾†ä¿å­˜å°è©±å…§å®¹ï¼Œé€™æ¨£æˆ‘å€‘å°±å¯ä»¥é€£çºŒå°è©±äº†
      thread.push({
        role: "user",
        parts: [{
          text: queAndMes
        }],
      });
      console.log(apiKey);
      fetch(
          //ANCHOR[id=ric25051815] AI APIçš„urlåŠ key
          "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=" +
          apiKey, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              contents: thread,
            }),
          }
        )
        .then(response => response.json())
        .then(data => {
          const message = document.getElementById("messageInput").value;
          const msg = data.candidates[0].content.parts[0].text;
          //document.getElementById("chatHistory").innerHTML +=
          //    "<div><div class='author'>AI:</div>" +
          //    converter.makeHtml(msg) + "<br/>You:<br/>" + message
          //    "</div>";
          // å–å¾—ç›®å‰çš„æ—¥æœŸæ™‚é–“
          const now = new Date();

          // å–å¾—å¹´ã€æœˆã€æ—¥ã€æ™‚ã€åˆ†ã€ç§’
          const year = now.getFullYear();
          const month = (now.getMonth() + 1).toString().padStart(2, '0'); // æœˆä»½æ˜¯å¾ 0 é–‹å§‹çš„ï¼Œæ‰€ä»¥è¦åŠ  1
          const day = now.getDate().toString().padStart(2, '0');
          const hours = now.getHours().toString().padStart(2, '0');
          const minutes = now.getMinutes().toString().padStart(2, '0');
          const seconds = now.getSeconds().toString().padStart(2, '0');

          // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“å­—ä¸²
          const formattedTime = `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;

          // å°‡ AI å›è¦†å’Œæ™‚é–“å­—ä¸²çµ„åˆèµ·ä¾†
          const aiResponseWithTime = `AI(${formattedTime}):<br>${converter.makeHtml(msg)}`; // åŠ ä¸Š <br> æ›è¡Œ

          document.getElementById("chatHistory").innerHTML =
            "<div><div class='author'>" +
            aiResponseWithTime +
            "</div></div>" +
            document.getElementById("chatHistory").innerHTML;
          //ANCHOR[id=ric25051816] è¼¸å‡ºAIçš„ç­”æ¡ˆ
          document.getElementById('continueQuestion').checked = true;
          document.getElementById('messageInput').disabled = true;
          HideProgressBar();
          thread.push({
            role: "model",
            parts: [{
              text: queAndMes,
            }, ],
          });
        })
        .catch(error => {
          console.error("Error:", error);
          document.getElementById("chatHistory").innerHTML +=
            "<div><div class='author'>Bot:</div>Error: " +
            error +
            "</div>";
        });
    }
  </script>


  <script>
    let tokenClient;
    function handleSignIn() {
      ShowProgressBar();
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: '17673872927-2oerv6lo3asmhmltbok8th3c9un65q7v.apps.googleusercontent.com',
        scope: 'https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email',
        callback: (tokenResponse) => {
          gapi.load('client', () => {
            (async () => {
              await gapi.client.init({
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
                  'https://www.googleapis.com/discovery/v1/apis/oauth2/v2/rest'
                ]
              });
              gapi.client.setToken(tokenResponse);

              //ANCHOR[id=ric25051805] ä½¿ç”¨ Google API è·å–ç”¨æˆ·ä¿¡æ¯
              const userInfoResponse = await gapi.client.oauth2.userinfo.get();
              //ANCHOR[id=ric25051808] googleAccount å¸³è™Ÿè³‡æ–™å…ƒä»¶
              const googleAccount = {
                id: userInfoResponse.result.id,
                name: userInfoResponse.result.name,
                imageUrl: userInfoResponse.result.picture,
                email: userInfoResponse.result.email
              };
              //console.log(googleAccount);

              // ç™¼é€çµ¦ Cloud Function
              try {
                //ANCHOR[id=ric25051806] ç™¼é€çµ¦ Cloud Function
                //ANCHOR[id=ric25051807] await fetch(url)
                const response = await fetch('https://us-central1-personalaihelper-db2aa.cloudfunctions.net/askGemini', {
                  method: 'POST',        
                  headers: {
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify({
                    text: 'è«‹æ ¹æ“šæˆ‘çš„å¸³è™Ÿè³‡è¨Šå›å‚³çµæœ',
                    googleAccount: googleAccount
                  })
                });

                const data = await response.json();
                console.log('Cloud Function å›æ‡‰:', data);
                //ANCHOR[id=ric25051811] api Key å¡«å…¥å‰ç«¯æ–‡å­—æ–¹å¡Š
                document.getElementById("apiKey").value = data.aKey;
                //ANCHOR[id=ric25051812] è³‡æ–™å¤¾ID å¡«å…¥å‰ç«¯æ–‡å­—æ–¹å¡Š
                document.getElementById("gitHubToken").value = data.gitHubToken;
                if (document.getElementById("folderIdInput").value==''){
                  document.getElementById("folderIdInput").value = data.fId;
                }
                const isAutoGetData = document.getElementById('isAutoGetData').checked;
                //ANCHOR[id=ric25052004] æ˜¯å¦åœ¨ç™»å…¥æˆåŠŸå¾Œè‡ªå‹•å–å¾—è³‡æ–™
                if (document.getElementById("folderIdInput").value !== "" && isAutoGetData) {
                  //ANCHOR[id=ric25051813] é»æ“Šï¼Œå–å¾—è³‡æ–™
                  document.getElementById('butProcess').click();
                } else {
                  HideProgressBar();
                }
                //alert('ç™»å…¥æˆåŠŸ');
                $("#showMes").text("ç™»å…¥æˆåŠŸ");
              } catch (error) {
                console.error('å‘¼å« Cloud Function æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                alert('å‘¼å« Cloud Function æ™‚ç™¼ç”ŸéŒ¯èª¤');
              }
            })();
          });
        },
      });
      tokenClient.requestAccessToken();
    }

    async function listAllMdFiles(folderId) {
      const files = [];

      async function recurse(currentFolderId) {
        const res = await gapi.client.drive.files.list({
          q: `'${currentFolderId}' in parents and trashed = false`,
          fields: 'files(id, name, mimeType)',
          pageSize: 1000,
        });

        for (const file of res.result.files) {
          if (file.mimeType === 'application/vnd.google-apps.folder') {
            await recurse(file.id);
          } else if (file.name.endsWith('.md')) {
            //ANCHOR[id=ric25051814] éè¿´å–å¾—.mdæª”å…§å®¹
            files.push({
              id: file.id,
              name: file.name
            });
          }
        }
      }

      await recurse(folderId);
      return files;
    }

    async function fetchMarkdownContents(mdFiles) {
    const allContents = [];

    for (const file of mdFiles) {
    try {
    //ANCHOR[id=ric25052201] é¿å…äº‚ç¢¼ï¼Œä½¿ç”¨ gapi.client.request ä¾†å–å¾— Blobï¼Œç„¶å¾Œè‡ªå·±è½‰ ArrayBuffer
    const res = await fetch(`https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`, {
    headers: {
    Authorization: `Bearer ${gapi.auth.getToken().access_token}`
    }
    });

    const arrayBuffer = await res.arrayBuffer();
    const decoder = new TextDecoder('utf-8');
    const text = decoder.decode(arrayBuffer);
    const textSingleLine = text
    .replace(/[\r\n]+/g, ' ')
    .replace(/\s*(<[^>]+>)\s*/g, '$1')   // ç§»é™¤æ¨™ç±¤å‰å¾Œçš„ç©ºç™½
    .replace(/>\s+</g, '><')             // ç§»é™¤æ¨™ç±¤ä¹‹é–“çš„ç©ºç™½
    .replace(/\s{2,}/g, ' ')             // å¤šå€‹ç©ºç™½å£“æˆä¸€å€‹ç©ºæ ¼
    .trim();  
    ;
    allContents.push(`## ${file.name}\n${textSingleLine}`);
    } catch (err) {
          console.warn(`è®€å– ${file.name} å¤±æ•—`, err);
        }
      }

      let merged = allContents.join('\n\n');
      if (merged.length > 999999) {
        merged = merged.slice(0, 999999); // é™åˆ¶é•·åº¦
        alert("è³‡æ–™é•·åº¦è¶…é999999é™åˆ¶ï¼Œå·²æˆªæ–·");
      }

      return merged;
    }

    async function process() {
      //setTimeout('ShowProgressBar();',50);
      ShowProgressBar();
      const folderId = document.getElementById('folderIdInput').value.trim();
      const output = document.getElementById('output');
      output.textContent = 'è™•ç†ä¸­...';

      if (!folderId) {
        alert("è«‹è¼¸å…¥è³‡æ–™å¤¾ ID");
        return;
      }

      try {
        const mdFiles = await listAllMdFiles(folderId);
        if (mdFiles.length === 0) {
          alert("æ‰¾ä¸åˆ° .md æª”æ¡ˆ");
          throw new Error("æ‰¾ä¸åˆ° .md æª”æ¡ˆ");
        }

        const mergedContent = await fetchMarkdownContents(mdFiles);
        document.getElementById('messageInput').value = mergedContent;
        document.getElementById('continueQuestion').checked = false;
        HideProgressBar();
        document.getElementById('userQuestion').focus();
        // é¡¯ç¤ºåˆä½µå¾Œçš„ Markdown åŸæ–‡
        //document.getElementById('output').textContent = 'ğŸ“„ åˆä½µå…§å®¹ï¼š\n' + mergedContent;
        //const res = await fetch('https://us-central1-personalaihelper-db2aa.cloudfunctions.net/askGemini', {
        //  method: 'POST',
        //  headers: { 'Content-Type': 'application/json' },
        //  body: JSON.stringify({
        //    text: `ä»¥ä¸‹æ˜¯çŸ¥è­˜åº«å…§å®¹ï¼š\n${mergedContent}\n\nä½¿ç”¨è€…å•é¡Œï¼š${question}`
        //  }),
        //});

        // let data;
        //if (res.headers.get('content-type')?.includes('application/json')) {
        //  data = await res.json();
        // } else {
        //  const text = await res.text(); // ğŸ‘ˆ å›å‚³ç´”æ–‡å­—å°±æŠ“é€™å€‹
        //  throw new Error(text);         // ä¸Ÿå‡ºéŒ¯èª¤çµ¦ catch è™•ç†
        //}
        //if (data.answer) {
        //   output.textContent = 'ğŸ” å›ç­”ï¼š\n' + data.answer;
        // } else {
        //  output.textContent = 'âš ï¸ ç„¡æ³•å–å¾—å›ç­”ï¼Œä¼ºæœå™¨å›å‚³ï¼š\n' + JSON.stringify(data, null, 2);
        // }

      } catch (err) {
        // output.textContent = 'âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š\n' + err.message;
        // console.error(err);
      }
    }
  </script>
  <div id="divProgress" style="text-align:center; display: none; position: fixed; top: 50%;  left: 50%;">
    <img src="loading.gif" />
    <br />
    <font color="#1B3563" size="2px">è³‡æ–™è™•ç†ä¸­</font>
  </div>
  <div id="divMaskFrame" style="background-color: #F2F4F7; display: none; left: 0px;
  position: absolute; top: 0px;">
  </div>
</body>

</html>
